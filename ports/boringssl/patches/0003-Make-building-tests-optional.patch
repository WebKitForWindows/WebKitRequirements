From 5f7f30f0960d9cff6148da022dd4734cc734df46 Mon Sep 17 00:00:00 2001
From: Don <don.j.olmstead@gmail.com>
Date: Mon, 29 Aug 2022 15:38:04 -0700
Subject: [PATCH 3/4] Make building tests optional

---
 CMakeLists.txt             | 4 ++++
 crypto/CMakeLists.txt      | 2 ++
 crypto/test/CMakeLists.txt | 2 ++
 decrepit/CMakeLists.txt    | 2 ++
 ssl/CMakeLists.txt         | 2 ++
 ssl/test/CMakeLists.txt    | 2 ++
 6 files changed, 14 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 031b298d8..c079c5d3e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -570,12 +570,14 @@ if(USE_CUSTOM_LIBCXX)
   install(TARGETS libcxx EXPORT OpenSSLTargets DESTINATION ${CMAKE_INSTALL_LIBDIR})
 endif()
 
+if(ENABLE_TESTING)
 # Add minimal googletest targets. The provided one has many side-effects, and
 # googletest has a very straightforward build.
 add_library(boringssl_gtest STATIC third_party/googletest/src/gtest-all.cc)
 target_include_directories(boringssl_gtest PRIVATE third_party/googletest)
 
 include_directories(third_party/googletest/include)
+endif()
 
 # Declare a dummy target to build all unit tests. Test targets should inject
 # themselves as dependencies next to the target definition.
@@ -658,6 +660,7 @@ else()
   add_custom_target(fips_specific_tests_if_any)
 endif()
 
+if(ENABLE_TESTING)
 add_custom_target(
     run_tests
     COMMAND ${GO_EXECUTABLE} run util/all_tests.go -build-dir
@@ -668,6 +671,7 @@ add_custom_target(
     WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
     DEPENDS all_tests bssl_shim handshaker fips_specific_tests_if_any
     USES_TERMINAL)
+endif()
 
 install(DIRECTORY include/ DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
 
diff --git a/crypto/CMakeLists.txt b/crypto/CMakeLists.txt
index d769efdaa..eae23feab 100644
--- a/crypto/CMakeLists.txt
+++ b/crypto/CMakeLists.txt
@@ -480,6 +480,7 @@ if(USE_CUSTOM_LIBCXX)
   target_link_libraries(crypto libcxx)
 endif()
 
+if(ENABLE_TESTING)
 # urandom_test is a separate binary because it needs to be able to observe the
 # PRNG initialisation, which means that it can't have other tests running before
 # it does.
@@ -573,3 +574,4 @@ if(WIN32)
   target_link_libraries(crypto_test ws2_32)
 endif()
 add_dependencies(all_tests crypto_test)
+endif()
diff --git a/crypto/test/CMakeLists.txt b/crypto/test/CMakeLists.txt
index b968fd78c..767f61474 100644
--- a/crypto/test/CMakeLists.txt
+++ b/crypto/test/CMakeLists.txt
@@ -1,3 +1,4 @@
+if(ENABLE_TESTING)
 add_library(
   test_support_lib
 
@@ -29,3 +30,4 @@ add_library(
 )
 
 add_dependencies(boringssl_gtest_main global_target)
+endif()
diff --git a/decrepit/CMakeLists.txt b/decrepit/CMakeLists.txt
index 16985da19..7bcb7dc42 100644
--- a/decrepit/CMakeLists.txt
+++ b/decrepit/CMakeLists.txt
@@ -26,6 +26,7 @@ add_dependencies(decrepit global_target)
 
 target_link_libraries(decrepit crypto ssl)
 
+if(ENABLE_TESTING)
 add_executable(
   decrepit_test
 
@@ -47,3 +48,4 @@ if(WIN32)
   target_link_libraries(decrepit_test ws2_32)
 endif()
 add_dependencies(all_tests decrepit_test)
+endif()
diff --git a/ssl/CMakeLists.txt b/ssl/CMakeLists.txt
index b4b103261..1f0fa9370 100644
--- a/ssl/CMakeLists.txt
+++ b/ssl/CMakeLists.txt
@@ -56,6 +56,7 @@ add_dependencies(ssl global_target)
 
 target_link_libraries(ssl crypto)
 
+if(ENABLE_TESTING)
 add_executable(
   ssl_test
 
@@ -73,3 +74,4 @@ if(WIN32)
   target_link_libraries(ssl_test ws2_32)
 endif()
 add_dependencies(all_tests ssl_test)
+endif()
diff --git a/ssl/test/CMakeLists.txt b/ssl/test/CMakeLists.txt
index f02d6e24f..e312929e3 100644
--- a/ssl/test/CMakeLists.txt
+++ b/ssl/test/CMakeLists.txt
@@ -1,3 +1,4 @@
+if(ENABLE_TESTING)
 include_directories(../../include)
 
 add_executable(
@@ -38,3 +39,4 @@ else()
   # Declare a dummy target for run_tests to depend on.
   add_custom_target(handshaker)
 endif()
+endif()
-- 
2.37.3.windows.1

